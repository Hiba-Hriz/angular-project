<div class="page-container">
    <div class="form-card">
        <div class="header-section">
            <h2 class="title-gradient">{{ isEditMode ? 'Modifier' : 'Ajouter' }} un Membre</h2>
            <p class="subtitle">Complétez les informations pour finaliser le profil</p>
        </div>

        <form [formGroup]="form" (ngSubmit)="sub()">
            <div *ngIf="errorMessage" class="alert-error" style="margin-bottom: 20px;">
                <mat-icon>error_outline</mat-icon>
                <span>{{ errorMessage }}</span>
            </div>
            <mat-stepper [linear]="false" #stepper>

                <mat-step>
                    <ng-template matStepLabel>Identité</ng-template>
                    <div class="step-content">
                        <div class="row">
                            <mat-form-field appearance="outline" class="full-width">
                                <mat-label>CIN</mat-label>
                                <input matInput formControlName="cin" placeholder="Ex: 01234567">
                                <mat-icon matSuffix>badge</mat-icon>
                            </mat-form-field>
                        </div>

                        <div class="row">
                            <mat-form-field appearance="outline" class="half-width">
                                <mat-label>Nom</mat-label>
                                <input matInput formControlName="nom">
                            </mat-form-field>
                            <mat-form-field appearance="outline" class="half-width">
                                <mat-label>Prénom</mat-label>
                                <input matInput formControlName="prenom">
                            </mat-form-field>
                        </div>

                        <div class="row">
                            <mat-form-field appearance="outline" class="full-width">
                                <mat-label>Date de Naissance</mat-label>
                                <input matInput [matDatepicker]="pickerN" formControlName="dateNaissance">
                                <mat-datepicker-toggle matSuffix [for]="pickerN"></mat-datepicker-toggle>
                                <mat-datepicker #pickerN></mat-datepicker>
                            </mat-form-field>
                        </div>

                        <div class="actions-footer">
                            <button mat-flat-button color="primary" matStepperNext type="button">
                                Suivant <mat-icon>arrow_forward</mat-icon>
                            </button>
                        </div>
                    </div>
                </mat-step>

                <mat-step>
                    <ng-template matStepLabel>Compte</ng-template>
                    <div class="step-content">
                        <div class="row">
                            <mat-form-field appearance="outline" class="half-width">
                                <mat-label>Email professionnel</mat-label>
                                <input matInput type="email" formControlName="email" placeholder="nom@exemple.com">
                                <mat-icon matSuffix>email</mat-icon>
                            </mat-form-field>

                            <mat-form-field appearance="outline" class="half-width">
                                <mat-label>Mot de passe</mat-label>
                                <input matInput type="password" formControlName="password">
                                <mat-icon matSuffix>lock</mat-icon>
                                <mat-hint *ngIf="isEditMode">Laissez vide pour ne pas modifier</mat-hint>
                            </mat-form-field>
                        </div>

                        <div class="row file-upload-section">

                            <div class="file-box half-width">
                                <label class="section-label">Photo de profil</label>
                                <div class="upload-control">
                                    <input type="file" #photoInput (change)="onFileSelected($event, 'photo')"
                                        accept="image/*" hidden>
                                    <button mat-stroked-button type="button" (click)="photoInput.click()">
                                        <mat-icon>image</mat-icon> Choisir une photo
                                    </button>
                                    <span class="file-name" *ngIf="form.get('photo')?.value">Fichier sélectionné</span>
                                </div>
                                <img *ngIf="photoPreview" [src]="photoPreview" class="image-preview">
                            </div>

                            <div class="file-box half-width">
                                <label class="section-label">Curriculum Vitae (PDF)</label>
                                <div class="upload-control">
                                    <input type="file" #cvInput (change)="onFileSelected($event, 'cv')" accept=".pdf"
                                        hidden>
                                    <button mat-button type="button" (click)="cvInput.click()">
                                        <mat-icon color="primary">cloud_upload</mat-icon>
                                        <span>Glissez ou cliquez pour votre CV</span>
                                    </button>
                                </div>
                                <div *ngIf="form.get('cv')?.value" class="pdf-indicator"
                                    style="color: #059669; font-weight: 600; margin-top: 10px; display: flex; align-items: center; gap: 5px;">
                                    <mat-icon style="font-size: 20px;">check_circle</mat-icon> Document prêt à l'envoi
                                </div>
                            </div>

                        </div>

                        <div class="actions-footer">
                            <button mat-button matStepperPrevious type="button">Retour</button>
                            <button mat-flat-button color="primary" matStepperNext type="button">
                                Suivant <mat-icon>arrow_forward</mat-icon>
                            </button>
                        </div>
                    </div>
                </mat-step>

                <mat-step>
                    <ng-template matStepLabel>Spécifications</ng-template>
                    <div class="step-content">
                        <label class="section-label">Sélectionnez le type de profil :</label>
                        <mat-radio-group formControlName="type" class="type-radio-group" (change)="onTypeChange()">
                            <mat-radio-button value="etudiant" class="type-card">
                                <mat-icon>school</mat-icon>
                                <span>Étudiant</span>
                            </mat-radio-button>
                            <mat-radio-button value="enseignant" class="type-card">
                                <mat-icon>psychology</mat-icon>
                                <span>Enseignant</span>
                            </mat-radio-button>
                        </mat-radio-group>

                        <div *ngIf="form.get('type')?.value === 'etudiant'" formGroupName="etudiantFields"
                            class="specific-fields-box">
                            <div class="row">
                                <mat-form-field appearance="outline" class="half-width">
                                    <mat-label>Diplôme préparé</mat-label>
                                    <mat-select formControlName="diplome">
                                        <mat-option value="Mastère">Mastère</mat-option>
                                        <mat-option value="Doctorat">Doctorat (Thèse)</mat-option>
                                    </mat-select>
                                </mat-form-field>


                            </div>

                            <div class="row">
                                <mat-form-field appearance="outline" class="full-width">
                                    <mat-label>Encadrant (Enseignant)</mat-label>
                                    <mat-select formControlName="encadrantId">
                                        <mat-option [value]="null">-- Aucun --</mat-option>
                                        <mat-option *ngFor="let ens of enseignants" [value]="ens.id">
                                            {{ ens.name }} {{ ens.prenom }} ({{ ens.grade }})
                                        </mat-option>
                                    </mat-select>
                                </mat-form-field>
                            </div>
                        </div>

                        <div *ngIf="form.get('type')?.value === 'enseignant'" formGroupName="enseignantFields"
                            class="specific-fields-box">
                            <div class="row">
                                <mat-form-field appearance="outline" class="half-width">
                                    <mat-label>Grade</mat-label>
                                    <mat-select formControlName="grade">
                                        <mat-option value="Professeur">Professeur</mat-option>
                                        <mat-option value="Maître Assistant">Maître Assistant</mat-option>
                                        <mat-option value="Maître de Conférences">Maître de Conférences</mat-option>
                                        <mat-option value="Assistant">Assistant</mat-option>
                                    </mat-select>
                                </mat-form-field>

                                <mat-form-field appearance="outline" class="half-width">
                                    <mat-label>Établissement</mat-label>
                                    <input matInput formControlName="etablissement" placeholder="Ex: ENIS">
                                </mat-form-field>
                            </div>
                        </div>

                        <div class="actions-footer">
                            <button mat-button matStepperPrevious type="button">Retour</button>


                            <button mat-flat-button class="btn-save" type="submit" [disabled]="isLoading">
                                <mat-icon *ngIf="!isLoading">check_circle</mat-icon>
                                {{ isLoading ? 'Traitement...' : (isEditMode ? 'Mettre à jour' : 'Créer le membre') }}
                            </button>
                        </div>
                    </div>
                </mat-step>
            </mat-stepper>
        </form>
    </div>
</div>